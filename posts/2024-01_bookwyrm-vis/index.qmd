---
title: "Bookywrm Visualisations"
description: "A pilot"
abstract: |
  This tutorial provides a detailed step-by-step process that demonstrates how to use R and Imagemagik to produce a Matrix-like image as well as highlights some key take away lessons I learnt from this experiencefrom doing that.
date: 2024-03-05
# title-block-banner: true
author: 
  - name: "Carlos CÃ¡mara"
    orcid: 0000-0002-9378-0549
    email: carlos.camara@warwick.ac.uk
    affiliations:
    - name: University of Warwick
      address: Centre for Interdisciplinary Methodologies (CIM), Social Sciences Building
      city: Coventry
      state: WA
      postal-code: CV4 7AL
categories:
  - Python
  - bookyrm
format:
  html:
    toc: true
    #code-line-numbers: true
    reference-location: margin
editor: visual
---

```{python}
import pandas as pd
import altair as alt

df = pd.read_csv("data/bookwyrm-export.csv")

df.head()
```

## Number of pages

## Authors

Favourite authors

```{python}

#df = df.filter()


alt.Chart(df[df[['author_text']].notnull().all(1)]
).mark_bar().encode(
    x='count()',
    y=alt.Y('author_text').sort('-x').title('Author')
).properties(
  title='Top Authors'
)
```

Authors by gender

# retrieve info from wikidata

https://query.wikidata.org/

Python modules:

- https://pypi.org/project/Wikidata/
- https://pypi.org/project/sparqldataframe/


From chatgpt: https://w.wiki/93Sf

```sparql
SELECT ?human ?humanLabel ?dob ?gender ?wikidataUrl
WHERE {
  ?human rdfs:label "Haruki Murakami"@en.
  ?human wdt:P31 wd:Q5;  # Instance of human
         wdt:P569 ?dob;  # Date of birth
         wdt:P21 ?gender;  # Gender
         wdt:P31 wd:Q5.  # Ensure the entity is a human
  
  BIND(wd:Q42 AS ?wikidataUrl)  # Replace Q42 with the actual QID of Haruki Murakami
  SERVICE wikibase:label { bd:serviceParam wikibase:language "[AUTO_LANGUAGE],en". }
}


```


https://www.markhneedham.com/blog/2020/01/29/newbie-guide-querying-wikidata/


Query: https://w.wiki/93RX

```rdf
SELECT DISTINCT ?item ?itemLabel ?sex_or_gender ?sex_or_genderLabel ?date_of_birth ?date_of_death ?occupation ?occupationLabel ?sexual_orientation ?sexual_orientationLabel ?personal_pronoun ?statement1Label WHERE {
  SERVICE wikibase:label { bd:serviceParam wikibase:language "[AUTO_LANGUAGE]". }
  {
    SELECT DISTINCT ?item WHERE {
      ?item p:P31 ?statement0.
      ?statement0 (ps:P31/(wdt:P279*)) wd:Q5.
      ?item p:P2561 ?statement1.
      ?statement1 ps:P2561 _:anyValueP2561.
    }
    LIMIT 100
  }
  OPTIONAL { ?item wdt:P21 ?sex_or_gender. }
  OPTIONAL { ?item wdt:P569 ?date_of_birth. }
  OPTIONAL { ?item wdt:P570 ?date_of_death. }
  OPTIONAL { ?item wdt:P106 ?occupation. }
  OPTIONAL { ?item wdt:P91 ?sexual_orientation. }
  OPTIONAL { ?item wdt:P6553 ?personal_pronoun. }
}
```

```{python}
# pip install sparqlwrapper
# https://rdflib.github.io/sparqlwrapper/

import sys
from SPARQLWrapper import SPARQLWrapper, JSON

endpoint_url = "https://query.wikidata.org/sparql"

query = """SELECT DISTINCT ?item ?itemLabel ?sex_or_gender ?sex_or_genderLabel ?date_of_birth ?date_of_death ?occupation ?occupationLabel WHERE {
  SERVICE wikibase:label { bd:serviceParam wikibase:language "[AUTO_LANGUAGE]". }
  {
    SELECT DISTINCT ?item WHERE {
      ?item p:P31 ?statement0.
      ?statement0 (ps:P31/(wdt:P279*)) wd:Q5.
      ?item p:P2561 ?statement1.
      ?statement1 ps:P2561 _:anyValueP2561.
    }
    LIMIT 10
  }
  OPTIONAL { ?item wdt:P21 ?sex_or_gender. }
  OPTIONAL { ?item wdt:P569 ?date_of_birth. }
  OPTIONAL { ?item wdt:P570 ?date_of_death. }
  OPTIONAL { ?item wdt:P106 ?occupation. }
}"""


def get_results(endpoint_url, query):
    user_agent = "WDQS-example Python/%s.%s" % (sys.version_info[0], sys.version_info[1])
    # TODO adjust user agent; see https://w.wiki/CX6
    sparql = SPARQLWrapper(endpoint_url, agent=user_agent)
    sparql.setQuery(query)
    sparql.setReturnFormat(JSON)
    return sparql.query().convert()


results = get_results(endpoint_url, query)

for result in results["results"]["bindings"]:
    print(result)

```

```{python}
from SPARQLWrapper import SPARQLWrapper, JSON

NAME_FRAGMENT = "Andreotti"

QUERY = f"""
SELECT DISTINCT ?uri 
WHERE {{ 
   ?uri a foaf:Person. 
   ?uri ?p ?person_full_name. 
   FILTER(?p IN(dbo:birthName,dbp:birthName ,dbp:fullname,dbp:name)). 
   ?uri rdfs:label ?person_name . 
   ?person_name bif:contains "{NAME_FRAGMENT}" .  
   FILTER(langMatches(lang(?person_full_name), "en")) .
}} 
LIMIT 100
"""

# Specify the DBPedia endpoint
sparql = SPARQLWrapper("http://dbpedia.org/sparql")
sparql.setQuery(QUERY)
sparql.setReturnFormat(JSON)

# Run the query
result = sparql.query().convert()

# The return data contains "bindings" (a list of dictionaries)
for link in result["results"]["bindings"]:
    # We want the "value" attribute of the "comment" field
    print(link["uri"]["value"])
```


```{python}
from SPARQLWrapper import SPARQLWrapper, JSON

def get_wikidata_info(selected_author="Haruki Murakami"):
    # SPARQL query with a parameter for the selected_author
    query = """
    SELECT ?human ?humanLabel ?dob ?gender ?wikidataUrl
    WHERE {
      ?human rdfs:label ?label.
      ?human wdt:P31 wd:Q5;  # Instance of human
             wdt:P569 ?dob;  # Date of birth
             wdt:P21 ?gender;  # Gender
             wdt:P31 wd:Q5.  # Ensure the entity is a human

      FILTER(LANG(?label) = "en" && STR(?label) = STR(?selected_author))

      BIND(wd:Q42 AS ?wikidataUrl)  # Replace Q42 with the actual QID of the specified label
      SERVICE wikibase:label { bd:serviceParam wikibase:language "[AUTO_LANGUAGE],en". }
    }
    """

    # Create a SPARQLWrapper object and set the endpoint
    sparql = SPARQLWrapper("https://query.wikidata.org/sparql")
    sparql.setQuery(query)

    # Set the parameters
    sparql.setParams({
        "selected_author": selected_author
    })

    # Define the request headers
    sparql.addCustomHttpHeader("User-Agent", "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36")

    # Set the result format to JSON
    sparql.setReturnFormat(JSON)

    # Execute the query and parse the results
    results = sparql.query().convert()

    # Print the results
    for result in results['results']['bindings']:
        print(result['humanLabel']['value'])
        print("Date of Birth:", result['dob']['value'])
        print("Gender:", result['gender']['value'])
        print("Wikidata URL:", result['wikidataUrl']['value'])
        print()

# Example usage
selected_author = "Haruki Murakami"  # Change this to the label you want to query
get_wikidata_info(selected_author)

```


Info:

- https://www.jcchouinard.com/wikidata-api-python/
- https://pypi.org/project/sparqldataframe/
- https://itnext.io/extracting-data-from-wikidata-using-sparql-and-python-59e0037996f
- https://people.wikimedia.org/~bearloga/notes/wdqs-python.html
Publication Year
- https://stackoverflow.com/questions/39773812/how-to-query-for-people-using-wikidata-and-sparql

